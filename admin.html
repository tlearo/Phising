<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Cyber Escape Rooms — Admin dashboard with team progress, charts, and data sync." />
  <link rel="icon" href="assets/favicon.png" type="image/png" />

  <!-- Tight CSP for static hosting (local assets only) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self';
                 connect-src 'self';
                 object-src 'none';
                 base-uri 'self'">

  <title>Cyber Escape Rooms — Admin Dashboard</title>

  <!-- External files only; no inline CSS/JS per your request -->
  <link rel="stylesheet" href="css/styles.css" />
  <script src="js/accessibility.js" defer></script>
  <script src="js/utils.js" defer></script>
  <script src="js/state-sync.js" defer></script>
  <script src="js/session.js" defer></script>
  <script src="js/Chart.min.js" defer></script>
  <script src="js/admin.js" defer></script>
</head>

<body data-session="admin">
  <a class="skip-link" href="#main">Skip to content</a>

  <!-- Global Header -->
  <header class="site-header site-header--bar" aria-label="Global">
    <div class="site-header__inner">
      <div class="header-left">
        <button class="nav-btn ghost nav-btn--back" type="button" data-back="index.html" data-tooltip="Back to previous page">
          <span aria-hidden="true">←</span>
          <span>Back</span>
        </button>
        <a class="brand" href="admin.html">
          <img src="assets/logo.png" alt="" class="logo" />
          <span class="brand-copy">
            <span class="brand-name">Cyber Escape Rooms</span>
            <span class="brand-tagline">Team-based security missions</span>
          </span>
        </a>
      </div>

      <div class="header-actions">
        <nav class="main-nav" aria-label="Primary">
          <a class="nav-link" href="game.html" data-visible="team">Mission Hub</a>
          <a class="nav-link" href="admin.html">Admin</a>
        </nav>
        <button class="nav-btn alert nav-btn--logout" type="button" data-action="logout">Logout</button>
      </div>
    </div>
  </header>

  <!-- Wider container for dashboards -->
  <main class="container container-xl admin-main" id="main" role="main" tabindex="-1">
    <header class="game-header" aria-labelledby="adminTitle">
      <h1 id="adminTitle" class="glow">Admin Dashboard</h1>
      <p id="adminWelcome" class="mt-1" style="color:var(--muted)">Welcome, ADMIN!</p>
    </header>

    <!-- Fun escape-room overlays (hooks only; style/JS later) -->
    <div id="confettiLayer" aria-hidden="true">
      <button class="celebrate-close" id="celebrateClose" type="button" aria-label="Close celebration">&times;</button>
      <div class="admin-podium" aria-hidden="true">
        <div class="admin-podium__inner">
          <h2 class="admin-podium__title">Team Podium</h2>
          <ol id="adminPodiumList" class="admin-podium__list"></ol>
        </div>
      </div>
    </div>
    <div id="spotlightLayer" aria-hidden="true"></div>

    <!-- Admin Grid: left = teams/stats/controls, right = charts -->
    <div class="admin-grid mt-2">

      <!-- LEFT column -->
      <aside class="admin-left" aria-label="Team progress and controls">
        <section class="card" aria-labelledby="teamProgressHeading">
          <h2 id="teamProgressHeading">Team Progress</h2>
          <div id="teamProgressList" class="team-grid mt-1" aria-live="polite"></div>
        </section>

        <section class="card mt-2" aria-labelledby="statsHeading">
          <h2 id="statsHeading">Stats &amp; Metrics</h2>
          <p id="averageTimeStats" class="mt-1"></p>
          <ul class="mt-1" style="list-style: disc; padding-left: 1.25rem">
            <li>Total teams detected: <strong id="statTotalTeams">—</strong></li>
            <li>Overall puzzles completed: <strong id="statTotalCompleted">—</strong></li>
            <li>Average completion time: <strong id="statAvgTime">—</strong></li>
          </ul>
          <p class="muted mt-1">Use this panel to track overall progress and average performance. Vault digits stay hidden so teams must earn them firsthand.</p>
        </section>

      </aside>

      <!-- RIGHT column: charts + notes -->
      <section class="admin-right" aria-label="Charts and notes">
        <section class="card admin-analytics" aria-labelledby="chartHeading">
          <div class="chart-header">
            <h2 id="chartHeading">Team Analytics</h2>
            <div class="chart-tabs" role="tablist">
              <button class="chart-tab is-active" type="button" data-target="progressChart" aria-controls="progressChart" aria-selected="true">Puzzle Completion</button>
              <button class="chart-tab" type="button" data-target="timeChart" aria-controls="timeChart" aria-selected="false">Avg Time (s)</button>
              <button class="chart-tab" type="button" data-target="challengeChart" aria-controls="challengeChart" aria-selected="false">Per Puzzle</button>
            </div>
          </div>
          <div class="chart-carousel">
            <canvas id="progressChart" data-panel="progressChart" width="400" height="220" class="chart-panel is-active" role="img"
                    aria-label="Bar chart of puzzles completed per team"></canvas>
            <canvas id="timeChart" data-panel="timeChart" width="400" height="220" class="chart-panel" role="img"
                    aria-label="Bar chart of average completion times per team"></canvas>
            <canvas id="challengeChart" data-panel="challengeChart" width="400" height="220" class="chart-panel" role="img"
                    aria-label="Bar chart showing how many teams completed each challenge"></canvas>
          </div>
        </section>

        <section class="card admin-activity mt-2" aria-labelledby="activityHeading">
          <div class="activity-header">
            <h2 id="activityHeading">Recent Activity</h2>
            <div class="activity-filters" aria-label="Activity filters">
              <label>
                <span class="sr-only">Filter by team</span>
                <select id="activityTeamFilter" aria-label="Filter by team"></select>
              </label>
              <label>
                <span class="sr-only">Filter by type</span>
                <select id="activityTypeFilter" aria-label="Filter by activity type"></select>
              </label>
            </div>
          </div>
          <div id="recentActivityList" class="activity-list-wrapper" aria-live="polite"></div>
        </section>

        <section class="card admin-sessions mt-2" aria-labelledby="sessionHeading">
          <h2 id="sessionHeading">Active Sessions</h2>
          <p class="muted">Snapshot of who is online and their latest action.</p>
          <ul class="session-list" id="sessionList"></ul>
        </section>

        <div class="admin-tools-grid mt-2">
          <!-- Data Sync (Netlify ↔ Neon) — hooks only -->
          <section class="card" aria-labelledby="syncHeading">
          <h2 id="syncHeading">Data Sync (Netlify ↔ Neon)</h2>
          <p class="mt-1" style="color:var(--muted)">
            Pull/push team progress to a Neon Postgres instance (wire-up later).
          </p>
          <div class="flex mt-1 control-row">
            <button class="btn" id="pullNeonBtn" type="button" title="Fetch latest stats from Neon">Pull from Neon</button>
            <button class="btn ghost" id="pushNeonBtn" type="button" title="Write local stats to Neon">Push to Neon</button>
          </div>
          <p id="syncStatus" class="mt-1 muted" aria-live="polite"></p>
          <div class="sync-diagnostics mt-1" id="syncDiagnostics" aria-live="polite"></div>
          <div class="flex mt-1 control-row">
            <button class="btn ghost" id="validateDataBtn" type="button">Run validation</button>
            <button class="btn ghost" id="downloadStateBtn" type="button">Download snapshot</button>
          </div>
        </section>

          <!-- Game Controls / Utilities -->
          <section class="card" aria-labelledby="controlsHeading">
            <h2 id="controlsHeading">Controls</h2>
            <div class="flex mt-1 control-row">
              <button class="btn" id="resetAllProgress" type="button">Reset All Teams</button>
              <button class="btn ghost" id="toggleSpotlight" type="button">Toggle Spotlight</button>
              <button class="btn ghost" id="togglePodium" type="button">Toggle Podium</button>
              <button class="btn ghost" id="triggerConfetti" type="button">Celebrate</button>
            </div>
            <div class="flex mt-1 control-row">
              <a class="btn ghost" id="backToLogin" href="index.html">Back to Login</a>
              <button class="btn" type="button" data-action="logout">Logout</button>
            </div>
          </section>
        </div>

        <!-- Optional: notes panel for admins -->
        <section class="card admin-notes mt-2" aria-labelledby="notesHeading">
          <h2 id="notesHeading">Admin Notes</h2>
          <p class="mt-1" style="color:var(--muted)">Jot observations during a session (local only).</p>
          <div class="field mt-1">
            <label for="adminNotes">Notes</label>
            <textarea id="adminNotes" rows="4" style="width:100%;"></textarea>
          </div>
          <div class="flex mt-1">
            <button class="btn" id="saveNotesBtn" type="button">Save Notes</button>
            <button class="btn ghost" id="clearNotesBtn" type="button">Clear</button>
          </div>
          <p id="notesStatus" class="mt-1" aria-live="polite" style="color:var(--muted)"></p>
        </section>
      </section>
    </div>

    <footer class="mt-3">
      <p style="color:var(--muted)">Charts update based on each team’s local progress and timing data.</p>
    </footer>
  </main>

  <!-- Global Footer -->
  <footer class="site-footer header-bleed">
    <div class="footer-inner">
      <nav class="footer-nav" aria-label="Footer">
        <a href="index.html">Home</a>
        <span aria-hidden="true">•</span>
        <a href="game.html">Mission Hub</a>
        <span aria-hidden="true">•</span>
        <a href="admin.html" aria-current="page">Admin</a>
      </nav>
      <p class="footer-note">Monitor team progress, sync data, and celebrate strong cyber habits.</p>
      <p class="footer-copy"><small>&copy; 2025 Cyber Escape Rooms</small></p>
    </div>
  </footer>

  <!-- Minimal inline handlers (no logic) -->
  <!-- Points Log Modal -->
  <div id="pointsModal" class="admin-modal" aria-hidden="true">
    <div class="admin-modal__overlay" data-close-modal></div>
    <div class="admin-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="pointsModalTitle">
      <button class="admin-modal__close" type="button" data-close-modal aria-label="Close points log">&times;</button>
      <h2 id="pointsModalTitle">Team Points Log</h2>
      <p id="pointsModalSubtitle" class="muted"></p>
      <canvas id="pointsModalChart" width="520" height="240" aria-hidden="true"></canvas>
      <div id="pointsModalLog" class="points-log-list mt-1" role="region" aria-live="polite"></div>
      <form id="pointsAdjustForm" class="points-adjust-form mt-2">
        <div class="field">
          <label for="pointsAdjustAmount">Adjust points by</label>
          <input id="pointsAdjustAmount" name="amount" type="number" step="1" value="0" required />
        </div>
        <div class="field">
          <label for="pointsSetTotal">Or set total to</label>
          <input id="pointsSetTotal" name="total" type="number" step="1" placeholder="Leave blank to keep current" />
        </div>
        <div class="field">
          <label for="pointsAdjustReason">Reason</label>
          <input id="pointsAdjustReason" name="reason" type="text" placeholder="e.g. Manual adjustment" required data-sanitize="loose" />
        </div>
        <div class="points-adjust-actions">
          <button class="btn" type="submit">Apply Changes</button>
          <button class="btn ghost" type="button" id="pointsResetBtn">Clear Log</button>
        </div>
        <p class="muted mt-1" id="pointsAdjustFeedback" aria-live="polite"></p>
      </form>
    </div>
  </div>
</body>
</html>
